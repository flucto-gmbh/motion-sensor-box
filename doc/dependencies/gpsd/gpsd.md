# GPSD - compilation, installation and configuration

The motion sensor box relies on [gpsd](https://gpsd.io/) and chronyd to generate an accurate time stamp for all its measurements. Therefore a Navilock NL-852ETLL GNSS receiver is attached to the serial port /dev/ttySC0. 
Apart from the standard NMEA sentence transmitted via serial port, a second signal (1 pulse per second, PPS) is generated by the receiver. This line is attached to GPIO Pin 13 (see [yasb pinout](../../images/YASB_pinout.png)).

Because the gpsd package provided by raspberry pi OS is quite old, the upstream gpsd code must first be pulled, compiled and installed, following the [official guide](https://gitlab.com/gpsd/gpsd/-/blob/master/build.adoc) and more specifically [this](https://gpsd.io/installation.html#_other_raspberry_pi_tips).
 
The configuration of chronyd follows largely [this](https://www.slsmk.com/how-to-setup-a-gps-pps-ntp-time-server-on-raspberry-pi/) instruction. 

## Prerequisites

Optional: if you want to check if PPS is already present, change into the repository and run the following script:


```bash
python3 msb/scripts/check_pps_interrupt.py
```

If you periodically get the following printout:

```bash
1612802151.0014236: received pps signal
1612802152.0014026: received pps signal
1612802153.0013947: received pps signal
1612802154.0013726: received pps signal
1612802155.0013838: received pps signal
1612802156.0013916: received pps signal
1612802157.0013967: received pps signal
1612802158.0013816: received pps signal
1612802159.0013947: received pps signal
```

proceed with the installation.

## Installation of gpsd

1. change into the source folder lib/gpsd. gpsd is a submodule in the yasb repository.
2. build gpsd by running:

```bash
scons -config=force
```

3. check the build by running

```bash
scons check
```

4. install udev rules by running

```bash
sudo scons udev-install
```

## Running gpsd

gpsd is now installed and can be tested by running which will run gpsd in the foreground. To stop gpsd again, press `CTRL+C`.

```bash
sudo gpsd -N -n /dev/ttySC0 /dev/pps0 
```

## Configuration

### systemd

per default, gpsd installs `gpsd.service` and `gpsd.socket` at `/usr/lib/systemd/system/`

You can start gpsd by typing `sudo systemctl start gpsd`

You can check gpsd's status by typing `sudo systemctl status gpsd`.

The following lists the systemd service and socket file.

gpsd.service

```bash
[Unit]
Description=GPS (Global Positioning System) Daemon
Requires=gpsd.socket
# Needed with chrony SOCK refclock
After=chronyd.service

[Service]
Type=forking
EnvironmentFile=-/etc/default/gpsd
EnvironmentFile=-/etc/sysconfig/gpsd
ExecStart=/usr/local/sbin/gpsd $GPSD_OPTIONS $OPTIONS $DEVICES

[Install]
WantedBy=multi-user.target
Also=gpsd.socket
```

gpsd.socket

```bash
[Unit]
Description=GPS (Global Positioning System) Daemon Sockets

[Socket]
ListenStream=/run/gpsd.sock
ListenStream=[::1]:2947
ListenStream=127.0.0.1:2947
# To allow gpsd remote access, start gpsd with the -G option and
# uncomment the next two lines:
# ListenStream=[::]:2947
# ListenStream=0.0.0.0:2947
SocketMode=0600
BindIPv6Only=yes

[Install]
WantedBy=sockets.target
```

## Interfacing gpsd with client applications
Official documentation [here](https://gpsd.gitlab.io/gpsd/client-howto.html)


